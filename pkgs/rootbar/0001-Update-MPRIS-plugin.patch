From 5658beb16a8d826d5281b34b21161a429150c64b Mon Sep 17 00:00:00 2001
From: clippy <clippy@localhost>
Date: Sun, 20 Aug 2023 09:51:03 +0700
Subject: [PATCH 1/3] Update MPRIS plugin

---
 plugins/mpris.c | 54 ++++++++++++++++++++++++++++++-------------------
 1 file changed, 33 insertions(+), 21 deletions(-)

diff --git a/plugins/mpris.c b/plugins/mpris.c
index e338e60..2268197 100644
--- a/plugins/mpris.c
+++ b/plugins/mpris.c
@@ -25,7 +25,7 @@
 
 #include <gtk/gtk.h>
 
-static const char* arg_names[] = {"player", "fifo", "prev_text", "play_text", "next_text", "show_title", "format", "length"};
+static const char* arg_names[] = {"player", "fifo", "prev_text", "play_text", "next_text", "show_title", "format", "length", "activatable"};
 
 struct mpris {
 	GDBusProxy* player;
@@ -36,6 +36,7 @@ struct mpris {
 	bool show_title;
 	char* format;
 	size_t length;
+	bool activatable;
 };
 
 struct cmd_info {
@@ -286,29 +287,39 @@ static void setup_dbus(struct mpris* this) {
 		fprintf(stderr, "Failed to connect to dbus\n");
 		return;
 	}
-	GVariant* ret = g_dbus_proxy_call_sync(proxy, "ListNames", NULL, G_DBUS_CALL_FLAGS_NONE, 2000, NULL, NULL);
-	g_object_unref(proxy);
 
-	GVariant* names = g_variant_get_child_value(ret, 0);
-	for(size_t count = 0; count < g_variant_n_children(names); ++count) {
-		GVariant* name = g_variant_get_child_value(names, count);
-		const char* name_str = g_variant_get_string(name, NULL);
-		if(strstr(name_str, "org.mpris.MediaPlayer2") != NULL) {
-			if(strstr(name_str, this->player_name) != NULL) {
-				g_variant_unref(ret);
-
-				if(this->show_title) {
-					this->properties = g_dbus_proxy_new_for_bus_sync(G_BUS_TYPE_SESSION, G_DBUS_PROXY_FLAGS_NONE, NULL, name_str, "/org/mpris/MediaPlayer2", "org.freedesktop.DBus.Properties", NULL, NULL);
-					g_signal_connect(this->properties, "g-signal", G_CALLBACK(dbus_signal), this);
-				}
-
-				this->player = g_dbus_proxy_new_for_bus_sync(G_BUS_TYPE_SESSION, G_DBUS_PROXY_FLAGS_NONE, NULL, name_str, "/org/mpris/MediaPlayer2", "org.mpris.MediaPlayer2.Player", NULL, NULL);
-				if(this->player == NULL) {
-					fprintf(stderr, "Failed to connect to the player\n");
-					return;
-				}
+	char name_str[1024] = { 0 };
+	if (this->activatable) {
+		snprintf(name_str, 1024, "org.mpris.MediaPlayer2.%s", this->player_name);
+	} else {
+		GVariant* ret = g_dbus_proxy_call_sync(proxy, "ListNames", NULL, G_DBUS_CALL_FLAGS_NONE, 2000, NULL, NULL);
+		GVariant* names = g_variant_get_child_value(ret, 0);
+		for(size_t count = 0; count < g_variant_n_children(names); ++count) {
+			GVariant* name = g_variant_get_child_value(names, count);
+			const char* vname_str = g_variant_get_string(name, NULL);
+			if (strstr(name_str, "org.mpris.MediaPlayer2") != NULL &&
+			    strstr(name_str, this->player_name) != NULL) {
+				strcpy(name_str, vname_str);
+				g_variant_unref(name);
+				break;
+			} else {
+				g_variant_unref(name);
+				continue;
 			}
 		}
+		g_variant_unref(ret);
+	}
+	g_object_unref(proxy);
+	if (name_str[0]) {
+		if(this->show_title) {
+			this->properties = g_dbus_proxy_new_for_bus_sync(G_BUS_TYPE_SESSION, G_DBUS_PROXY_FLAGS_NONE, NULL, name_str, "/org/mpris/MediaPlayer2", "org.freedesktop.DBus.Properties", NULL, NULL);
+			g_signal_connect(this->properties, "g-signal", G_CALLBACK(dbus_signal), this);
+		}
+
+		this->player = g_dbus_proxy_new_for_bus_sync(G_BUS_TYPE_SESSION, G_DBUS_PROXY_FLAGS_NONE, NULL, name_str, "/org/mpris/MediaPlayer2", "org.mpris.MediaPlayer2.Player", NULL, NULL);
+		if(this->player == NULL) {
+			fprintf(stderr, "Failed to connect to the player\n");
+		}
 	}
 }
 
@@ -325,6 +336,7 @@ void* rootbar_mpris_init(struct map* props, GtkBox* box) {
 		this->show_title = strcmp(config_get(props, "", "show_title", "true"), "true") == 0;
 		this->format = strdup(config_get(props, "", "format", "%s"));
 		this->length = strtol(config_get(props, "", "length", "50"), NULL, 10);
+		this->activatable = strcmp(config_get(props, "", "activatable", "true"), "true") == 0;
 
 		this->player_name = strdup(player_name);
 		setup_dbus(this);
-- 
2.49.0

